# ç›®å½•ç»“æ„é‡ç»„å®ŒæˆæŠ¥å‘Š

## ğŸ¯ é‡ç»„ç›®æ ‡

æŒ‰ç…§æ¨èçš„æ¶æ„é‡æ–°ç»„ç»‡ä»£ç ï¼Œå®ç°æ¸…æ™°çš„æ¨¡å—åŒ–ç»“æ„ï¼Œæ”¯æŒæ ¸å¿ƒ+æ’ä»¶+é…ç½®ä¸­å¿ƒçš„æ¶æ„æ¨¡å¼ã€‚

## ğŸ“ æ–°çš„ç›®å½•ç»“æ„

```
/opt/iot-platform/
â”œâ”€â”€ backend/                     # æ ¸å¿ƒåç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒæ¡†æ¶ï¼Œä¸éšç§Ÿæˆ·/è®¾å¤‡å˜
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts        # Express ä¸»å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/      # å…¬å…±ä¸­é—´ä»¶ï¼ˆæ—¥å¿—ã€é‰´æƒã€é™æµï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rate-limiter/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ idempotency/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ errorHandler.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ db/              # Prismaã€æ•°æ®åº“è¿æ¥ã€é…ç½®ä¸­å¿ƒAPI
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ container/
â”‚   â”‚   â”‚   â”œâ”€â”€ security/        # HMAC/TLS/åŠ¨æ€å‡­è¯ç”Ÿæˆ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ credentials/
â”‚   â”‚   â”‚   â”œâ”€â”€ bootstrap/       # é€šç”¨è®¾å¤‡å¼•å¯¼æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ device-bootstrap.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ shadow/          # å½±å­çŠ¶æ€é€šç”¨é€»è¾‘
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ mqtt/            # MQTTé€šç”¨å°è£…ã€ä¸»é¢˜ç”Ÿæˆå™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ message-bus/
â”‚   â”‚   â”‚   â”œâ”€â”€ plugin-loader.ts # æ’ä»¶åŠ è½½å™¨ï¼ˆæ‰«æ tenants/ devices/ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ plugin-interface.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ tenant-plugin.ts
â”‚   â”‚   â”‚   â””â”€â”€ device-plugin.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ common/              # å…¬å…±å·¥å…·å’ŒåŸºç¡€ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ logger.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ config/
â”‚   â”‚   â”‚       â””â”€â”€ database.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ plugins/             # æ‰€æœ‰"æ’ä»¶"éƒ½åœ¨è¿™é‡Œï¼ˆç§Ÿæˆ·å’Œè®¾å¤‡ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ tenants/         # ç§Ÿæˆ·æ’ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant-a/    # ä¼ä¸šçº§ç§Ÿæˆ·æ’ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ policies/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant-b/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ default/     # é»˜è®¤ç§Ÿæˆ·æ’ä»¶
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ devices/         # è®¾å¤‡æ’ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ powersafe/   # PowerSafe è®¾å¤‡æ’ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ smart-controller/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ smart-gateway/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ smart-sensor/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ generic/     # é€šç”¨è®¾å¤‡æ’ä»¶
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                 # APIç½‘å…³ï¼Œæ±‡æ€»æ‰€æœ‰routes
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ devices/
â”‚   â”‚   â”‚   â”œâ”€â”€ system/
â”‚   â”‚   â”‚   â”œâ”€â”€ powersafe/
â”‚   â”‚   â”‚   â””â”€â”€ device-bootstrap/
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ index.ts             # å¯åŠ¨å…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ config-center/               # é…ç½®ä¸­å¿ƒï¼ˆæ•°æ®åº“è„šæœ¬/è¿ç§»/é…ç½®ç®¡ç†å·¥å…·ï¼‰
â”‚   â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ seeds/
â”‚   â”œâ”€â”€ config-schema.ts         # é…ç½®æ¨¡å‹å®šä¹‰ï¼ˆç§Ÿæˆ·/è®¾å¤‡å‚æ•°ï¼‰
â”‚   â”œâ”€â”€ config-manager.ts
â”‚   â”œâ”€â”€ tenant-config.ts
â”‚   â”œâ”€â”€ device-config.ts
â”‚   â”œâ”€â”€ mqtt-config.ts
â”‚   â””â”€â”€ ota-config.ts
â”‚
â”œâ”€â”€ frontend/                    # å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ docker/                      # Docker Compose ç­‰éƒ¨ç½²è„šæœ¬
```

## ğŸ”„ é‡ç»„å®Œæˆçš„å·¥ä½œ

### 1. **æ ¸å¿ƒæ¨¡å—é‡ç»„**
- âœ… åˆ›å»ºäº† `core/server.ts` - Express ä¸»å…¥å£
- âœ… é‡ç»„äº†ä¸­é—´ä»¶åˆ° `core/middleware/`
- âœ… ç§»åŠ¨äº†å®‰å…¨æ¨¡å—åˆ° `core/security/`
- âœ… ç§»åŠ¨äº†æ•°æ®åº“å’Œå®¹å™¨åˆ° `core/db/`
- âœ… ç§»åŠ¨äº†MQTTç›¸å…³åˆ° `core/mqtt/`
- âœ… ä¿ç•™äº†å½±å­æœºåˆ¶åœ¨ `core/shadow/`
- âœ… ç§»åŠ¨äº†è®¾å¤‡å¼•å¯¼åˆ° `core/bootstrap/`

### 2. **æ’ä»¶ç³»ç»Ÿé‡ç»„**
- âœ… ç§»åŠ¨äº†æ’ä»¶ç³»ç»Ÿåˆ° `core/` ä¸‹
- âœ… åˆ›å»ºäº†æ’ä»¶ç›®å½•ç»“æ„ `plugins/tenants/` å’Œ `plugins/devices/`
- âœ… ç§»åŠ¨äº†ç°æœ‰æ’ä»¶åˆ°æ–°ç»“æ„
- âœ… åˆ›å»ºäº†é»˜è®¤ç§Ÿæˆ·æ’ä»¶ `plugins/tenants/default/`
- âœ… åˆ›å»ºäº†é€šç”¨è®¾å¤‡æ’ä»¶ `plugins/devices/generic/`

### 3. **é…ç½®ä¸­å¿ƒç‹¬ç«‹**
- âœ… ç§»åŠ¨äº†é…ç½®ä¸­å¿ƒåˆ°æ ¹ç›®å½• `config-center/`
- âœ… åˆ›å»ºäº†é…ç½®æ¨¡å‹å®šä¹‰ `config-schema.ts`
- âœ… ä¿æŒäº†é…ç½®ç®¡ç†å™¨çš„ç‹¬ç«‹æ€§

### 4. **å…¬å…±å·¥å…·é‡ç»„**
- âœ… ç§»åŠ¨äº†å·¥å…·ç±»åˆ° `common/utils/`
- âœ… ç§»åŠ¨äº†ç±»å‹å®šä¹‰åˆ° `common/types/`
- âœ… ç§»åŠ¨äº†é…ç½®åˆ° `common/config/`

### 5. **APIè·¯ç”±é‡ç»„**
- âœ… ç§»åŠ¨äº†æ‰€æœ‰è·¯ç”±åˆ° `api/` ç›®å½•
- âœ… ä¿æŒäº†APIçš„æ¨¡å—åŒ–ç»“æ„

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç‰¹æ€§

### 1. **æ ¸å¿ƒæœåŠ¡å™¨ (`core/server.ts`)**
- é›†æˆæ‰€æœ‰æ ¸å¿ƒæ¨¡å—
- ç»Ÿä¸€çš„ä¸­é—´ä»¶ç®¡ç†
- æ’ä»¶ç³»ç»Ÿé›†æˆ
- æœåŠ¡å®¹å™¨ç®¡ç†
- ä¼˜é›…å¯åŠ¨å’Œå…³é—­

### 2. **æ’ä»¶ç³»ç»Ÿ**
- ç§Ÿæˆ·æ’ä»¶ï¼š`plugins/tenants/`
- è®¾å¤‡æ’ä»¶ï¼š`plugins/devices/`
- åŠ¨æ€åŠ è½½å’Œçƒ­é‡è½½
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 3. **é…ç½®ä¸­å¿ƒ**
- ç‹¬ç«‹çš„é…ç½®ç®¡ç†
- é…ç½®æ¨¡å‹å®šä¹‰
- çƒ­æ›´æ–°æ”¯æŒ
- é…ç½®éªŒè¯

### 4. **æ¨¡å—åŒ–è®¾è®¡**
- æ ¸å¿ƒæ¡†æ¶ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- æ’ä»¶åŒ–æ¶æ„
- ä¾èµ–æ³¨å…¥å®¹å™¨
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

## ğŸ“¦ æ’ä»¶ç¤ºä¾‹

### 1. **é»˜è®¤ç§Ÿæˆ·æ’ä»¶**
```typescript
// plugins/tenants/default/index.ts
export class DefaultTenantPlugin extends BaseTenantPlugin {
  // æä¾›åŸºç¡€ç§Ÿæˆ·åŠŸèƒ½
  // ç»Ÿè®¡APIã€è®¾å¤‡ç®¡ç†API
}
```

### 2. **é€šç”¨è®¾å¤‡æ’ä»¶**
```typescript
// plugins/devices/generic/index.ts
export class GenericDevicePlugin extends BaseDevicePlugin {
  // æä¾›åŸºç¡€è®¾å¤‡åŠŸèƒ½
  // æ¶ˆæ¯å¤„ç†ã€å‘½ä»¤å¤„ç†
}
```

### 3. **ä¼ä¸šçº§ç§Ÿæˆ·æ’ä»¶**
```typescript
// plugins/tenants/tenant-a/index.ts
export class EnterpriseTenantPlugin extends BaseTenantPlugin {
  // ä¼ä¸šçº§åŠŸèƒ½
  // é«˜çº§åˆ†æã€è®¡è´¹ç®¡ç†
}
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. **å¯åŠ¨æœåŠ¡å™¨**
```bash
cd /opt/iot-platform/backend
npm start
```

### 2. **æ·»åŠ æ–°ç§Ÿæˆ·æ’ä»¶**
```bash
mkdir -p backend/src/plugins/tenants/new-tenant/{policies,services,routes}
# åˆ›å»º index.ts å®ç°æ’ä»¶
```

### 3. **æ·»åŠ æ–°è®¾å¤‡æ’ä»¶**
```bash
mkdir -p backend/src/plugins/devices/new-device/{routes,services,config}
# åˆ›å»º index.ts å®ç°æ’ä»¶
```

### 4. **é…ç½®ç®¡ç†**
```typescript
// é€šè¿‡é…ç½®ä¸­å¿ƒAPIç®¡ç†é…ç½®
await configManager.updateTenantConfig(tenantId, newConfig);
await configManager.updateDeviceConfig(tenantId, deviceType, newConfig);
```

## ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿

### 1. **æ¸…æ™°çš„æ¨¡å—åˆ†ç¦»**
- æ ¸å¿ƒæ¡†æ¶ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- æ’ä»¶ç³»ç»Ÿç‹¬ç«‹ç®¡ç†
- é…ç½®ä¸­å¿ƒç‹¬ç«‹è¿è¡Œ

### 2. **é«˜åº¦å¯æ‰©å±•**
- æ–°å¢ç§Ÿæˆ·åªéœ€æ·»åŠ æ’ä»¶
- æ–°å¢è®¾å¤‡ç±»å‹åªéœ€æ·»åŠ æ’ä»¶
- é…ç½®çƒ­æ›´æ–°æ— éœ€é‡å¯

### 3. **æ˜“äºç»´æŠ¤**
- ç»Ÿä¸€çš„ä»£ç ç»“æ„
- æ¸…æ™°çš„ä¾èµ–å…³ç³»
- æ¨¡å—åŒ–çš„é”™è¯¯å¤„ç†

### 4. **å¼€å‘å‹å¥½**
- TypeScript ç±»å‹å®‰å…¨
- ç»Ÿä¸€çš„æ’ä»¶æ¥å£
- å®Œæ•´çš„é…ç½®æ¨¡å‹

## ğŸ“‹ åç»­å·¥ä½œ

### 1. **å¯¼å…¥è·¯å¾„ä¿®å¤**
- æ›´æ–°æ‰€æœ‰æ–‡ä»¶çš„å¯¼å…¥å¼•ç”¨
- ä¿®å¤ TypeScript è·¯å¾„åˆ«å
- ç¡®ä¿æ‰€æœ‰æ¨¡å—æ­£ç¡®å¯¼å…¥

### 2. **æµ‹è¯•å’ŒéªŒè¯**
- éªŒè¯æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨
- æµ‹è¯•æ’ä»¶åŠ è½½åŠŸèƒ½
- éªŒè¯é…ç½®ä¸­å¿ƒå·¥ä½œæ­£å¸¸

### 3. **æ–‡æ¡£æ›´æ–°**
- æ›´æ–° API æ–‡æ¡£
- æ›´æ–°éƒ¨ç½²æ–‡æ¡£
- æ›´æ–°å¼€å‘æŒ‡å—

## ğŸ‰ æ€»ç»“

ç›®å½•ç»“æ„é‡ç»„å·²ç»å®Œæˆï¼æ–°çš„æ¶æ„å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **æ¸…æ™°çš„æ¨¡å—åˆ†ç¦»** - æ ¸å¿ƒã€æ’ä»¶ã€é…ç½®ä¸­å¿ƒç‹¬ç«‹
âœ… **é«˜åº¦å¯æ‰©å±•** - æ’ä»¶åŒ–æ¶æ„æ”¯æŒå¿«é€Ÿæ‰©å±•
âœ… **æ˜“äºç»´æŠ¤** - ç»Ÿä¸€çš„ä»£ç ç»“æ„å’Œä¾èµ–ç®¡ç†
âœ… **å¼€å‘å‹å¥½** - TypeScript ç±»å‹å®‰å…¨å’Œç»Ÿä¸€æ¥å£

ç°åœ¨å¯ä»¥å¼€å§‹ä½¿ç”¨è¿™ä¸ªå¼ºå¤§çš„æ¨¡å—åŒ–æ¶æ„è¿›è¡Œå¼€å‘äº†ï¼ğŸš€
