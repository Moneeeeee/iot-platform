# IoT å¹³å° V2 æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“– æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° IoT å¹³å° V2 çš„å®Œæ•´æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å¤šç§Ÿæˆ·ã€æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€OTA ç®¡ç†ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

**ç‰ˆæœ¬**: V2.0  
**æ—¥æœŸ**: 2025-01-06  
**çŠ¶æ€**: å®æ–½ä¸­

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™

1. **æ¨¡å—åŒ–**: è®¾å¤‡ç®¡ç†ã€æ¨¡æ¿ã€çŠ¶æ€ã€é¥æµ‹ã€å‘Šè­¦ã€OTAã€å›ºä»¶ä»“åº“ã€ç§Ÿæˆ·ã€ç”¨æˆ·ä¼šè¯ã€æ—¥å¿—ç­‰æ¨¡å—ç‹¬ç«‹ï¼Œæ¥å£æ¾è€¦åˆ
2. **å¯æ‰©å±•**: è®¾å¤‡å±æ€§/ä¼ æ„Ÿå™¨æ¨¡æ¿åŒ– + JSONï¼Œæ–°å¢è®¾å¤‡ç±»å‹ä¸æ”¹æ ¸å¿ƒè¡¨
3. **å¤šç§Ÿæˆ·**: ç»Ÿä¸€ tenant_idï¼Œæ‰€æœ‰æ¨¡å—æŒ‰ç§Ÿæˆ·éš”ç¦»ï¼Œä¸­é—´ä»¶é‰´æƒæ³¨å…¥ tenant_id
4. **åˆ†å±‚æ•°æ®**: é«˜é¢‘ã€ä½é¢‘ã€ä½åŠŸè€—ã€ä¸€æ¬¡æ€§æµ‹é‡ç»Ÿä¸€æ¥å…¥ï¼ŒæŒ‰çƒ­/å†·åˆ†å±‚å­˜å‚¨ï¼Œå¯é…ç½®ä¿ç•™ç­–ç•¥
5. **å¼‚æ„åè®®ç»Ÿä¸€**: MQTTã€UDPã€WebSocket å…¥ç«™éƒ½èµ°ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æ€»çº¿ â†’ å­˜å‚¨å±‚/ä¸šåŠ¡å±‚æ’ä»¶

### éªŒæ”¶è¦ç‚¹

- âœ… æ–°å¢è®¾å¤‡ç±»å‹æ— éœ€æ”¹æ ¸å¿ƒè¡¨å³å¯è½åœ°
- âœ… ä½åŠŸè€—/ä¸€æ¬¡æ€§/äº‹ä»¶é©±åŠ¨æ¨¡å¼å‡å¯æ¥å…¥
- âœ… é¥æµ‹ä¿ç•™ç­–ç•¥å¯æŒ‰é…ç½®æ‰§è¡Œ
- âœ… OTA ç°åº¦å¯æŒ‰ç­–ç•¥åˆ†é…å¹¶å¯è¿½è¸ª
- âœ… å¤šç§Ÿæˆ·éš”ç¦»é»˜è®¤ç”Ÿæ•ˆï¼Œè·¨æ¨¡å—ä¸€è‡´

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯å±‚ (Client Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Web UI   â”‚  â”‚ Mobile   â”‚  â”‚ API      â”‚  â”‚ CLI      â”‚   â”‚
â”‚  â”‚ (React)  â”‚  â”‚ App      â”‚  â”‚ Clients  â”‚  â”‚ Tools    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS / WebSocket
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘å…³å±‚ (Gateway Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Nginx Reverse Proxy + Load Balancer                 â”‚  â”‚
â”‚  â”‚  - SSL/TLS Termination                               â”‚  â”‚
â”‚  â”‚  - Rate Limiting                                      â”‚  â”‚
â”‚  â”‚  - Request Routing                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application Layer)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Node.js + Express + TypeScript           â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ REST API     â”‚  â”‚ WebSocket    â”‚  â”‚ GraphQL     â”‚â”‚ â”‚
â”‚  â”‚  â”‚ /api/*       â”‚  â”‚ /ws          â”‚  â”‚ (Optional)  â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚         ä¸­é—´ä»¶å±‚ (Middleware Layer)              â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - å¤šç§Ÿæˆ·ä¸­é—´ä»¶ (Tenant Extraction)             â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - JWT è®¤è¯ (Auth Middleware)                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - æƒé™æ§åˆ¶ (RBAC)                              â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - è¯·æ±‚æ—¥å¿— (Request Logging)                   â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - é”™è¯¯å¤„ç† (Error Handler)                     â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚ (Business Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è®¾å¤‡ç®¡ç†    â”‚  â”‚  OTAç®¡ç†    â”‚  â”‚  æ•°æ®ä¿ç•™ç­–ç•¥        â”‚ â”‚
â”‚  â”‚  - æ¨¡æ¿å¼•æ“  â”‚  â”‚  - å›ºä»¶ä»“åº“  â”‚  â”‚  - å†·çƒ­åˆ†å±‚         â”‚ â”‚
â”‚  â”‚  - éªŒè¯å™¨    â”‚  â”‚  - ç°åº¦å‘å¸ƒ  â”‚  â”‚  - è‡ªåŠ¨æ¸…ç†         â”‚ â”‚
â”‚  â”‚  - ç”Ÿå‘½å‘¨æœŸ  â”‚  â”‚  - è¿›åº¦è¿½è¸ª  â”‚  â”‚  - æ•°æ®å‹ç¼©         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å‘Šè­¦ç®¡ç†    â”‚  â”‚  ç§Ÿæˆ·ç®¡ç†    â”‚  â”‚  ç”¨æˆ·ç®¡ç†           â”‚ â”‚
â”‚  â”‚  - è§„åˆ™å¼•æ“  â”‚  â”‚  - é™é¢æ§åˆ¶  â”‚  â”‚  - è§’è‰²æƒé™         â”‚ â”‚
â”‚  â”‚  - é€šçŸ¥åˆ†å‘  â”‚  â”‚  - é…é¢ç®¡ç†  â”‚  â”‚  - ä¼šè¯ç®¡ç†         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ¶ˆæ¯æ€»çº¿å±‚ (Message Bus Layer)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           ç»Ÿä¸€æ¶ˆæ¯æ€»çº¿ (Unified Message Bus)            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  Dev:  EventEmitter (å†…å­˜)                             â”‚ â”‚
â”‚  â”‚  Prod: Redis Pub/Sub (åˆ†å¸ƒå¼)                          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  é€šé“ (Channels):                                       â”‚ â”‚
â”‚  â”‚  - device:telemetry                                    â”‚ â”‚
â”‚  â”‚  - device:status                                       â”‚ â”‚
â”‚  â”‚  - device:events                                       â”‚ â”‚
â”‚  â”‚  - device:commands                                     â”‚ â”‚
â”‚  â”‚  - ota:progress                                        â”‚ â”‚
â”‚  â”‚  - ota:status                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Adapter   â”‚  â”‚  UDP Adapter    â”‚  â”‚  WS Adapter     â”‚
â”‚  - è®¾å¤‡é¥æµ‹     â”‚  â”‚  - UDP æ•°æ®æŠ¥   â”‚  â”‚  - å®æ—¶æ¨é€     â”‚
â”‚  - çŠ¶æ€ä¸ŠæŠ¥     â”‚  â”‚  - æ‰¹é‡æ•°æ®     â”‚  â”‚  - è®¢é˜…ç®¡ç†     â”‚
â”‚  - OTA å“åº”     â”‚  â”‚                 â”‚  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
            â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åè®®å±‚ (Protocol Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MQTT    â”‚  â”‚   UDP    â”‚  â”‚   TCP    â”‚  â”‚   HTTP   â”‚   â”‚
â”‚  â”‚  Broker  â”‚  â”‚  Server  â”‚  â”‚  Server  â”‚  â”‚  Server  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚ (Data Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       PostgreSQL + TimescaleDB (æ—¶åºæ•°æ®ä¼˜åŒ–)          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  æ ¸å¿ƒè¡¨ (å¤šç§Ÿæˆ·):                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ tenants               (ç§Ÿæˆ·)                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ users                 (ç”¨æˆ·)                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ device_templates      (è®¾å¤‡æ¨¡æ¿)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ devices               (è®¾å¤‡)                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ telemetry            â­Hypertable (é¥æµ‹æ•°æ®)      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ device_status_historyâ­Hypertable (çŠ¶æ€å†å²)      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ measurements          (ä¸€æ¬¡æ€§æµ‹é‡)                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ event_alerts          (äº‹ä»¶å‘Šè­¦)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ firmwares             (å›ºä»¶ä»“åº“)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ firmware_rollouts     (ç°åº¦å‘å¸ƒ)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ firmware_update_status (æ›´æ–°è¿½è¸ª)                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ retention_policies    (ä¿ç•™ç­–ç•¥)                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€ system_configs        (ç³»ç»Ÿé…ç½®)                  â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  æ—¶åºä¼˜åŒ–:                                              â”‚ â”‚
â”‚  â”‚  - åˆ†åŒºç­–ç•¥: 7å¤©/chunk (Telemetry)                     â”‚ â”‚
â”‚  â”‚  - å‹ç¼©ç­–ç•¥: 7å¤©åå‹ç¼©                                  â”‚ â”‚
â”‚  â”‚  - ä¿ç•™ç­–ç•¥: 3å¹´è‡ªåŠ¨æ¸…ç†                                â”‚ â”‚
â”‚  â”‚  - è¿ç»­èšåˆ: 5åˆ†é’Ÿ/1å°æ—¶èšåˆè§†å›¾                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Redis (ç¼“å­˜ + æ¶ˆæ¯)                    â”‚ â”‚
â”‚  â”‚  - ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜                                         â”‚ â”‚
â”‚  â”‚  - ä¼šè¯å­˜å‚¨                                             â”‚ â”‚
â”‚  â”‚  - æ¶ˆæ¯é˜Ÿåˆ— (Pub/Sub)                                   â”‚ â”‚
â”‚  â”‚  - é™æµè®¡æ•°                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å­˜å‚¨å±‚ (Storage Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  æœ¬åœ°å­˜å‚¨     â”‚  â”‚  å¯¹è±¡å­˜å‚¨     â”‚  â”‚  å¤‡ä»½å­˜å‚¨     â”‚     â”‚
â”‚  â”‚  /uploads     â”‚  â”‚  (S3/MinIO)  â”‚  â”‚  (Backup)    â”‚     â”‚
â”‚  â”‚  - å›ºä»¶æ–‡ä»¶   â”‚  â”‚  - å›ºä»¶å½’æ¡£   â”‚  â”‚  - æ•°æ®åº“    â”‚     â”‚
â”‚  â”‚  - æ—¥å¿—æ–‡ä»¶   â”‚  â”‚  - å†·æ•°æ®     â”‚  â”‚  - é…ç½®æ–‡ä»¶   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. ç§Ÿæˆ·ç®¡ç†

```prisma
model Tenant {
  id              String        // ç§Ÿæˆ· ID
  slug            String        // ç§Ÿæˆ·å”¯ä¸€æ ‡è¯†
  name            String        // ç§Ÿæˆ·åç§°
  plan            TenantPlan    // å¥—é¤: BASIC/PROFESSIONAL/ENTERPRISE
  status          TenantStatus  // çŠ¶æ€: ACTIVE/SUSPENDED/TRIAL
  isolatedSchema  Boolean       // æ˜¯å¦ä½¿ç”¨ç‹¬ç«‹ Schema
  schemaName      String?       // Schema åç§°
  limits          Json          // é™é¢é…ç½®
}
```

#### 2. è®¾å¤‡æ¨¡æ¿ï¼ˆæ‰©å±•æ ¸å¿ƒï¼‰

```prisma
model DeviceTemplate {
  id                  String
  tenantId            String
  name                String
  type                String          // è‡ªå®šä¹‰è®¾å¤‡ç±»å‹
  version             String          // æ¨¡æ¿ç‰ˆæœ¬
  
  // æ ¸å¿ƒæ‰©å±•ç‚¹ï¼šJSON Schema
  attributes          Json            // è®¾å¤‡å±æ€§å®šä¹‰
  telemetryMetrics    Json            // é¥æµ‹æŒ‡æ ‡å®šä¹‰
  events              Json            // äº‹ä»¶å®šä¹‰
  commands            Json            // æŒ‡ä»¤å®šä¹‰
  firmwareConstraints Json            // å›ºä»¶çº¦æŸ
}
```

**å±æ€§å®šä¹‰ç¤ºä¾‹**:

```json
{
  "attributes": {
    "voltage": {
      "type": "number",
      "unit": "V",
      "min": 0,
      "max": 500,
      "precision": 2,
      "serverMapping": "v"
    },
    "location": {
      "type": "object",
      "schema": {
        "lat": { "type": "number" },
        "lng": { "type": "number" }
      }
    }
  },
  "telemetryMetrics": [
    {
      "name": "temperature",
      "type": "number",
      "unit": "Â°C",
      "sampling": "1m",
      "range": [-40, 125],
      "validators": ["range(-40,125)"]
    }
  ],
  "commands": [
    {
      "name": "reboot",
      "params": {},
      "timeout": 30,
      "ackPolicy": "required",
      "retry": 3
    }
  ]
}
```

#### 3. æ—¶åºæ•°æ®è¡¨ï¼ˆTimescaleDBï¼‰

```prisma
model Telemetry {
  id        String
  tenantId  String
  deviceId  String
  timestamp DateTime      // åˆ†åŒºé”®
  metrics   Json          // é¥æµ‹æ•°æ®
  quality   DataQuality   // GOOD/UNCERTAIN/BAD
  protocol  ProtocolType
  source    String
}

// TimescaleDB Hypertable é…ç½®:
// - åˆ†åŒº: 7å¤©/chunk
// - å‹ç¼©: 7å¤©åè‡ªåŠ¨å‹ç¼©
// - ä¿ç•™: 3å¹´è‡ªåŠ¨æ¸…ç†
// - èšåˆ: 5åˆ†é’Ÿ/1å°æ—¶è¿ç»­èšåˆè§†å›¾
```

#### 4. OTA ç®¡ç†

```prisma
model Firmware {
  id          String
  tenantId    String
  version     String
  channel     FirmwareChannel  // STABLE/BETA/ALPHA
  filepath    String           // æ–‡ä»¶è·¯å¾„
  size        BigInt
  checksum    String           // SHA256
  metadata    Json
}

model FirmwareRollout {
  id          String
  firmwareId  String
  strategy    Json             // ç°åº¦ç­–ç•¥
  stats       Json             // è¿›åº¦ç»Ÿè®¡
  status      RolloutStatus    // DRAFT/ACTIVE/PAUSED/COMPLETED
}

model FirmwareUpdateStatus {
  deviceId    String
  rolloutId   String
  status      UpdateStatus     // PENDING/DOWNLOADING/INSTALLING/SUCCESS/FAILED
  progress    Int              // 0-100
  error       String?
}
```

**ç°åº¦ç­–ç•¥ç¤ºä¾‹**:

```json
{
  "type": "percentage",
  "percentage": 10,
  "increments": [10, 25, 50, 100],
  "filters": {
    "tags": ["pilot", "beta"],
    "regions": ["cn-east"]
  },
  "constraints": {
    "minBattery": 50,
    "wifiOnly": true,
    "timeWindow": {
      "start": "02:00",
      "end": "06:00"
    }
  },
  "rollback": {
    "autoRollback": true,
    "failureThreshold": 0.1
  }
}
```

### æ•°æ®åˆ†å±‚ç­–ç•¥

| å±‚çº§ | æ—¶é•¿ | åˆ†è¾¨ç‡ | å‹ç¼© | å­˜å‚¨ |
|------|------|--------|------|------|
| **Hot** | 30å¤© | åŸå§‹ | âŒ | SSD |
| **Warm** | 180å¤© | 5åˆ†é’Ÿèšåˆ | âœ… | SSD |
| **Cold** | 3å¹´ | 1å°æ—¶èšåˆ | âœ… | HDD |
| **Archive** | å¯é€‰ | 1å¤©èšåˆ | âœ… | S3 |

---

## ğŸ”Œ æ¶ˆæ¯æ€»çº¿è®¾è®¡

### ç»Ÿä¸€æ¶ˆæ¯ç±»å‹

```typescript
enum MessageType {
  TELEMETRY         // è®¾å¤‡é¥æµ‹æ•°æ®
  STATUS_CHANGE     // è®¾å¤‡çŠ¶æ€å˜æ›´
  DEVICE_EVENT      // è®¾å¤‡äº‹ä»¶
  MEASUREMENT       // ä¸€æ¬¡æ€§æµ‹é‡
  DEVICE_COMMAND    // è®¾å¤‡æŒ‡ä»¤
  COMMAND_RESPONSE  // æŒ‡ä»¤å“åº”
  OTA_PROGRESS      // OTA è¿›åº¦
  OTA_STATUS        // OTA çŠ¶æ€
}
```

### æ¶ˆæ¯æµè½¬

```
è®¾å¤‡ (MQTT) â†’ MQTT Adapter â†’ æ¶ˆæ¯æ€»çº¿ â†’ ä¸šåŠ¡å¤„ç†å™¨ â†’ æ•°æ®åº“
                                    â†“
                              WebSocket â†’ å‰ç«¯å®æ—¶æ›´æ–°
```

### æ¶ˆæ¯æ€»çº¿å®ç°

| ç¯å¢ƒ | å®ç° | ç‰¹æ€§ |
|------|------|------|
| **Development** | EventEmitter | å†…å­˜ï¼Œå•æœºï¼Œå¿«é€Ÿ |
| **Production** | Redis Pub/Sub | åˆ†å¸ƒå¼ï¼ŒæŒä¹…åŒ–ï¼Œé«˜å¯ç”¨ |

---

## ğŸ” å¤šç§Ÿæˆ·éš”ç¦»

### éš”ç¦»çº§åˆ«

#### é€»è¾‘éš”ç¦»ï¼ˆé»˜è®¤ï¼‰

```typescript
// ä¸­é—´ä»¶è‡ªåŠ¨æ³¨å…¥ tenant_id
req.tenant = { id: 'tenant_123', ... };

// Prisma è‡ªåŠ¨è¿‡æ»¤
prisma.device.findMany({
  where: { tenantId: req.tenant.id }
});
```

#### Schema éš”ç¦»ï¼ˆè¶…å¤§å®¢æˆ·ï¼‰

```typescript
// ç§Ÿæˆ·é…ç½®
{
  isolatedSchema: true,
  schemaName: 'tenant_enterprise_001'
}

// åŠ¨æ€åˆ‡æ¢ Schema
SET search_path TO tenant_enterprise_001;
```

### ç§Ÿæˆ·é™é¢ç®¡ç†

```json
{
  "limits": {
    "maxDevices": 10000,
    "maxUsers": 100,
    "maxTemplates": 50,
    "maxFirmwares": 20,
    "maxStorageGB": 100
  }
}
```

---

## ğŸš€ OTA ç°åº¦å‘å¸ƒæµç¨‹

```
1. ä¸Šä¼ å›ºä»¶ â†’ å›ºä»¶ä»“åº“
   â†“
2. åˆ›å»ºç°åº¦å‘å¸ƒ â†’ é…ç½®ç­–ç•¥
   â†“
3. å¯åŠ¨å‘å¸ƒ â†’ ç­›é€‰ç›®æ ‡è®¾å¤‡
   â†“
4. åˆ†é˜¶æ®µæ¨è¿› â†’ 10% â†’ 25% â†’ 50% â†’ 100%
   â†“
5. å®æ—¶ç›‘æ§ â†’ æˆåŠŸç‡ã€å¤±è´¥ç‡
   â†“
6. è‡ªåŠ¨å›æ»š â† å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼
   â†“
7. å®Œæˆå‘å¸ƒ â†’ ç»Ÿè®¡æŠ¥å‘Š
```

### ç°åº¦ç­–ç•¥ç±»å‹

| ç­–ç•¥ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ç™¾åˆ†æ¯”** | æŒ‰æ¯”ä¾‹åˆ†é… | 10% â†’ 25% â†’ 50% â†’ 100% |
| **æ ‡ç­¾** | æŒ‰è®¾å¤‡æ ‡ç­¾ | tags: ["pilot", "beta"] |
| **åœ°åŸŸ** | æŒ‰åœ°ç†ä½ç½® | regions: ["cn-east"] |
| **è®¾å¤‡åˆ—è¡¨** | æŒ‡å®šè®¾å¤‡ | deviceIds: ["dev_001"] |
| **æ—¶é—´çª—å£** | é™åˆ¶æ—¶é—´æ®µ | 02:00-06:00 |

---

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### å…³é”®æŒ‡æ ‡

```
ä¸šåŠ¡æŒ‡æ ‡:
- åœ¨çº¿è®¾å¤‡æ•°
- é¥æµ‹æ•°æ®ååé‡ (QPS)
- OTA æˆåŠŸç‡
- å‘Šè­¦è§¦å‘é¢‘ç‡

ç³»ç»ŸæŒ‡æ ‡:
- API å“åº”æ—¶é—´ (p50/p95/p99)
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- æ¶ˆæ¯æ€»çº¿å»¶è¿Ÿ
- å­˜å‚¨ä½¿ç”¨ç‡

ç§Ÿæˆ·æŒ‡æ ‡:
- ç§Ÿæˆ·è®¾å¤‡åˆ†å¸ƒ
- ç§Ÿæˆ· API è°ƒç”¨é‡
- ç§Ÿæˆ·é…é¢ä½¿ç”¨æƒ…å†µ
```

### æ—¥å¿—ç­–ç•¥

```
/var/log/iot-platform/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ application.log      (åº”ç”¨æ—¥å¿—)
â”‚   â”œâ”€â”€ access.log           (è®¿é—®æ—¥å¿—)
â”‚   â”œâ”€â”€ error.log            (é”™è¯¯æ—¥å¿—)
â”‚   â””â”€â”€ audit.log            (å®¡è®¡æ—¥å¿—)
â”œâ”€â”€ mqtt/
â”‚   â””â”€â”€ mqtt.log
â”œâ”€â”€ postgres/
â”‚   â””â”€â”€ postgresql.log
â””â”€â”€ nginx/
    â”œâ”€â”€ access.log
    â””â”€â”€ error.log
```

---

## ğŸ”§ éƒ¨ç½²æ¶æ„

### Docker Compose æ¶æ„

```yaml
services:
  nginx:         # åå‘ä»£ç† + è´Ÿè½½å‡è¡¡
  backend:       # Node.js åº”ç”¨
  mqtt-broker:   # MQTT Broker
  postgres:      # PostgreSQL + TimescaleDB
  redis:         # ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—
  grafana:       # ç›‘æ§ä»ªè¡¨ç›˜
  prometheus:    # æŒ‡æ ‡é‡‡é›†
```

### é«˜å¯ç”¨éƒ¨ç½²

```
Production (3-Node Cluster):
- 3x Backend (Load Balanced)
- 3x PostgreSQL (Primary + 2 Replicas)
- 3x Redis (Sentinel Mode)
- 2x MQTT Broker (Clustered)
```

---

## ğŸ“ æœ€ä½³å®è·µ

### æ–°å¢è®¾å¤‡ç±»å‹

```typescript
// 1. åˆ›å»ºè®¾å¤‡æ¨¡æ¿
const template = await prisma.deviceTemplate.create({
  data: {
    tenantId,
    name: 'Smart Temperature Sensor v2',
    type: 'temperature_sensor',
    version: '2.0.0',
    attributes: { /* JSON Schema */ },
    telemetryMetrics: [ /* æŒ‡æ ‡å®šä¹‰ */ ],
  }
});

// 2. åˆ›å»ºè®¾å¤‡å®ä¾‹
const device = await prisma.device.create({
  data: {
    tenantId,
    templateId: template.id,
    slug: 'sensor_001',
    name: 'Room Temperature Sensor',
  }
});

// âœ… æ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼
```

### æ•°æ®ä¿ç•™ç­–ç•¥

```typescript
// ç§Ÿæˆ·çº§é…ç½®
await RetentionPolicyEngine.createPolicy({
  tenantId,
  name: 'Standard Telemetry Policy',
  dataType: 'TELEMETRY',
  tiers: {
    hot: { duration: '30d', resolution: 'raw' },
    warm: { duration: '180d', resolution: '5m', compression: true },
    cold: { duration: '3y', resolution: '1h', compression: true },
  }
});

// è‡ªåŠ¨æ‰§è¡Œ
retentionScheduler.start(24); // æ¯24å°æ—¶æ‰§è¡Œä¸€æ¬¡
```

---

## ğŸ“¦ äº¤ä»˜æ¸…å•

âœ… **æ¨¡å—åŒ–æ•°æ®åº“æ¨¡å¼**: Prisma Schema V2  
âœ… **å¤šç§Ÿæˆ·ä¸­é—´ä»¶**: tenant.ts  
âœ… **æ¶ˆæ¯æ€»çº¿**: message-bus/index.ts  
âœ… **è®¾å¤‡æ¨¡æ¿å¼•æ“**: device-template/engine.ts  
âœ… **OTA ç®¡ç†ç³»ç»Ÿ**: ota/rollout-manager.ts  
âœ… **æ•°æ®ä¿ç•™ç­–ç•¥**: data-retention/policy-engine.ts  
âœ… **åè®®é€‚é…å™¨**: protocol-adapters/mqtt-adapter.ts  
âœ… **TimescaleDB é…ç½®**: timescaledb-setup.sql  
âœ… **è¿ç§»æŒ‡å—**: v2-migration-guide.md  
âœ… **æ¶æ„æ–‡æ¡£**: V2-Architecture-Design.md  

---

## ğŸ“ æ”¯æŒ

- **æ–‡æ¡£**: https://docs.iot-platform.com
- **API Reference**: https://api.iot-platform.com/docs
- **GitHub**: https://github.com/iot-platform/platform
- **æŠ€æœ¯æ”¯æŒ**: support@iot-platform.com

---

**Â© 2025 IoT Platform. All rights reserved.**

