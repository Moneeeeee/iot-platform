# IoT å¹³å° V2 æž¶æž„å®žæ–½æ€»ç»“

## ðŸŽ¯ æž¶æž„ç›®æ ‡

åŸºäºŽæ‚¨çš„è¦æ±‚ï¼Œæˆ‘ä»¬æˆåŠŸå®žçŽ°äº† **æ ¸å¿ƒ+æ’ä»¶+é…ç½®ä¸­å¿ƒ** çš„æ¨¡å—åŒ–æž¶æž„ï¼Œæ”¯æŒå¤šç§Ÿæˆ·ã€å¤šè®¾å¤‡ã€åŠ¨æ€é…ç½®å’Œ OTAã€‚

## ðŸ“ æž¶æž„ç»“æž„

```
backend/src/
â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ auth/               # ç»Ÿä¸€è®¤è¯å’Œç§Ÿæˆ·è§£æž
â”‚   â”œâ”€â”€ credentials/        # åŠ¨æ€å‡­è¯ä¸Ž ACL æ ¡éªŒ
â”‚   â”œâ”€â”€ adapters/           # MQTT/WebSocket/HTTP æŽ¥å…¥é€‚é…å™¨
â”‚   â”œâ”€â”€ shadow/             # å½±å­æœºåˆ¶ desired/reported çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ rate-limiter/       # é™æµç­–ç•¥
â”‚   â”œâ”€â”€ idempotency/        # æ¶ˆæ¯å¹‚ç­‰å¤„ç†
â”‚   â””â”€â”€ container/          # ä¾èµ–æ³¨å…¥å®¹å™¨
â”œâ”€â”€ config-center/          # é…ç½®ä¸­å¿ƒ
â”‚   â”œâ”€â”€ config-manager.ts   # é…ç½®ç®¡ç†å™¨
â”‚   â”œâ”€â”€ tenant-config.ts    # ç§Ÿæˆ·é…ç½®æœåŠ¡
â”‚   â”œâ”€â”€ device-config.ts    # è®¾å¤‡é…ç½®æœåŠ¡
â”‚   â”œâ”€â”€ mqtt-config.ts      # MQTT é…ç½®æœåŠ¡
â”‚   â””â”€â”€ ota-config.ts       # OTA é…ç½®æœåŠ¡
â”œâ”€â”€ plugins/                # æ’ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ plugin-interface.ts # æ’ä»¶æŽ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ plugin-loader.ts    # æ’ä»¶åŠ è½½å™¨
â”‚   â”œâ”€â”€ tenant-plugin.ts    # ç§Ÿæˆ·æ’ä»¶åŸºç±»
â”‚   â””â”€â”€ device-plugin.ts    # è®¾å¤‡æ’ä»¶åŸºç±»
â””â”€â”€ app.ts                  # ä¸»åº”ç”¨ï¼ˆé›†æˆæ‰€æœ‰æ¨¡å—ï¼‰

plugins/
â”œâ”€â”€ tenants/                # ç§Ÿæˆ·æ’ä»¶
â”‚   â””â”€â”€ enterprise-tenant/  # ä¼ä¸šçº§ç§Ÿæˆ·æ’ä»¶ç¤ºä¾‹
â””â”€â”€ devices/                # è®¾å¤‡æ’ä»¶
    â””â”€â”€ powersafe-datacenter/ # PowerSafe æ•°æ®ä¸­å¿ƒè®¾å¤‡æ’ä»¶ç¤ºä¾‹
```

## ðŸ—ï¸ æ ¸å¿ƒæ¨¡å— (Core Module)

### 1. è®¤è¯æœåŠ¡ (`core/auth`)
- **åŠŸèƒ½**: ç»Ÿä¸€è®¤è¯å’Œç§Ÿæˆ·è§£æž
- **æ”¯æŒ**: JWTã€API Keyã€è®¾å¤‡å‡­è¯ç­‰å¤šç§è®¤è¯æ–¹å¼
- **ç‰¹æ€§**: 
  - ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
  - æƒé™æ£€æŸ¥ä¸­é—´ä»¶
  - å¤šç§Ÿæˆ·éš”ç¦»

### 2. å‡­è¯æœåŠ¡ (`core/credentials`)
- **åŠŸèƒ½**: åŠ¨æ€å‡­è¯ä¸Ž ACL æ ¡éªŒ
- **ç‰¹æ€§**:
  - è®¾å¤‡åŠ¨æ€å‡­è¯ç”Ÿæˆï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
  - MQTT ACL è§„åˆ™è‡ªåŠ¨ç”Ÿæˆ
  - å‡­è¯éªŒè¯å’Œæ¸…ç†

### 3. åè®®é€‚é…å™¨ (`core/adapters`)
- **åŠŸèƒ½**: MQTT/WebSocket/HTTP æŽ¥å…¥é€‚é…å™¨
- **ç‰¹æ€§**:
  - ç»Ÿä¸€æ¶ˆæ¯å¤„ç†
  - å¤šåè®®æ”¯æŒ
  - æ¶ˆæ¯è·¯ç”±å’Œè½¬å‘

### 4. å½±å­æœåŠ¡ (`core/shadow`)
- **åŠŸèƒ½**: å½±å­æœºåˆ¶ desired/reported çŠ¶æ€ç®¡ç†
- **ç‰¹æ€§**:
  - æœŸæœ›æ€å’ŒæŠ¥å‘Šæ€ç®¡ç†
  - çŠ¶æ€å·®å¼‚è®¡ç®—
  - åŽ†å²è®°å½•æŸ¥è¯¢

### 5. é™æµæœåŠ¡ (`core/rate-limiter`)
- **åŠŸèƒ½**: åŸºäºŽç§Ÿæˆ·ã€è®¾å¤‡ã€ç”¨æˆ·çš„å¤šç§é™æµç­–ç•¥
- **ç‰¹æ€§**:
  - çµæ´»çš„é™æµè§„åˆ™é…ç½®
  - å¤šç»´åº¦é™æµï¼ˆAPIã€MQTTã€è®¾å¤‡ï¼‰
  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®¡æ•°å™¨

### 6. å¹‚ç­‰æœåŠ¡ (`core/idempotency`)
- **åŠŸèƒ½**: æ¶ˆæ¯å¹‚ç­‰å¤„ç†
- **ç‰¹æ€§**:
  - é‡å¤æ¶ˆæ¯æ£€æµ‹
  - å“åº”ç¼“å­˜
  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

### 7. æœåŠ¡å®¹å™¨ (`core/container`)
- **åŠŸèƒ½**: ä¾èµ–æ³¨å…¥å®¹å™¨
- **ç‰¹æ€§**:
  - æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - ä¾èµ–å…³ç³»è§£æž
  - ä¼˜é›…å¯åŠ¨å’Œå…³é—­

## âš™ï¸ é…ç½®ä¸­å¿ƒ (Config Center)

### 1. é…ç½®ç®¡ç†å™¨ (`config-manager`)
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®çš„åŠ è½½ã€æ›´æ–°ã€ç¼“å­˜
- **ç‰¹æ€§**:
  - 5åˆ†é’Ÿé…ç½®ç¼“å­˜
  - çƒ­æ›´æ–°æ”¯æŒ
  - é…ç½®å˜æ›´äº‹ä»¶é€šçŸ¥

### 2. ç§Ÿæˆ·é…ç½® (`tenant-config`)
- **åŠŸèƒ½**: ç®¡ç†ç§Ÿæˆ·çº§åˆ«é…ç½®
- **é…ç½®é¡¹**:
  - ä¸»é¢˜æ¨¡æ¿é…ç½®
  - é™æµé…ç½®
  - è®¡è´¹ç­–ç•¥
  - æ•°æ®ä¿ç•™ç­–ç•¥
  - å®‰å…¨é…ç½®

### 3. è®¾å¤‡é…ç½® (`device-config`)
- **åŠŸèƒ½**: ç®¡ç†è®¾å¤‡çº§åˆ«é…ç½®
- **é…ç½®é¡¹**:
  - é‡‡æ ·é…ç½®
  - é˜ˆå€¼é…ç½®
  - å‘Šè­¦é…ç½®
  - æ•°æ®å¤„ç†é…ç½®
  - è¿žæŽ¥é…ç½®

### 4. MQTT é…ç½® (`mqtt-config`)
- **åŠŸèƒ½**: ç®¡ç† MQTT ACL ä¸ŽåŠ¨æ€å‡­è¯é…ç½®
- **é…ç½®é¡¹**:
  - Broker é…ç½®
  - å®¢æˆ·ç«¯é…ç½®
  - TLS é…ç½®
  - ä¸»é¢˜é…ç½®
  - QoS å’Œ Retain ç­–ç•¥

### 5. OTA é…ç½® (`ota-config`)
- **åŠŸèƒ½**: ç®¡ç†å›ºä»¶æ›´æ–°ç­–ç•¥
- **é…ç½®é¡¹**:
  - å›ºä»¶ä»“åº“é…ç½®
  - ä¸‹è½½é…ç½®
  - å®‰è£…é…ç½®
  - ç°åº¦å‘å¸ƒé…ç½®
  - é€šçŸ¥é…ç½®

## ðŸ”Œ æ’ä»¶ç³»ç»Ÿ (Plugin System)

### 1. æ’ä»¶æŽ¥å£ (`plugin-interface`)
- **å®šä¹‰**: æ‰€æœ‰æ’ä»¶å¿…é¡»å®žçŽ°çš„æŽ¥å£
- **æŽ¥å£**:
  - `init()`: æ’ä»¶åˆå§‹åŒ–
  - `registerRoutes()`: æ³¨å†Œè·¯ç”±
  - `registerServices()`: æ³¨å†ŒæœåŠ¡
  - `onConfigUpdate()`: é…ç½®æ›´æ–°å›žè°ƒ
  - `shutdown()`: æ’ä»¶å¸è½½

### 2. æ’ä»¶åŠ è½½å™¨ (`plugin-loader`)
- **åŠŸèƒ½**: æ‰«æå¹¶åŠ è½½æ’ä»¶
- **ç‰¹æ€§**:
  - è‡ªåŠ¨æ‰«æ `plugins/tenants` å’Œ `plugins/devices`
  - åŠ¨æ€å¯¼å…¥æ’ä»¶
  - æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - çƒ­é‡è½½æ”¯æŒ

### 3. ç§Ÿæˆ·æ’ä»¶åŸºç±» (`tenant-plugin`)
- **åŠŸèƒ½**: ç§Ÿæˆ·å®šåˆ¶åŒ–åŠŸèƒ½çš„åŸºç±»
- **ç‰¹æ€§**:
  - ç§Ÿæˆ·ç‰¹å®šè·¯ç”±å‰ç¼€
  - ç§Ÿæˆ·æƒé™éªŒè¯
  - ç§Ÿæˆ·é€šçŸ¥æœåŠ¡
  - ç§Ÿæˆ·ç»Ÿè®¡ä¿¡æ¯

### 4. è®¾å¤‡æ’ä»¶åŸºç±» (`device-plugin`)
- **åŠŸèƒ½**: è®¾å¤‡å®šåˆ¶åŒ–åŠŸèƒ½çš„åŸºç±»
- **ç‰¹æ€§**:
  - è®¾å¤‡æ¨¡æ¿å®šä¹‰
  - æ¶ˆæ¯å¤„ç†
  - å‘½ä»¤å¤„ç†
  - æ•°æ®éªŒè¯å’Œè½¬æ¢

## ðŸ“¦ ç¤ºä¾‹æ’ä»¶

### 1. ä¼ä¸šçº§ç§Ÿæˆ·æ’ä»¶ (`enterprise-tenant`)
- **åŠŸèƒ½**: ä¼ä¸šçº§ç§Ÿæˆ·å®šåˆ¶åŒ–åŠŸèƒ½
- **ç‰¹æ€§**:
  - ä¼ä¸šçº§åˆ†æž API
  - ä¼ä¸šçº§æŠ¥å‘Šç”Ÿæˆ
  - è®¡è´¹ä¿¡æ¯ç®¡ç†
  - é«˜çº§ç»Ÿè®¡åŠŸèƒ½

### 2. PowerSafe æ•°æ®ä¸­å¿ƒè®¾å¤‡æ’ä»¶ (`powersafe-datacenter`)
- **åŠŸèƒ½**: PowerSafe æ•°æ®ä¸­å¿ƒè®¾å¤‡å®šåˆ¶åŒ–
- **ç‰¹æ€§**:
  - ä¸‰ç›¸ç”µåŠ›ç›‘æŽ§
  - åŠŸçŽ‡å¼‚å¸¸æ£€æµ‹
  - è®¾å¤‡æŽ§åˆ¶å‘½ä»¤
  - ä¸“ä¸šé¥æµ‹æŒ‡æ ‡

## ðŸš€ è¿ç»´ä¸Žæ¼”è¿›

### æ–°å¢žç§Ÿæˆ·
```bash
# 1. åœ¨ plugins/tenants ä¸‹åˆ›å»ºæ–°æ–‡ä»¶å¤¹
mkdir plugins/tenants/new-tenant

# 2. åˆ›å»ºé…ç½®æ–‡ä»¶
cat > plugins/tenants/new-tenant/config.json << EOF
{
  "name": "new-tenant",
  "version": "1.0.0",
  "description": "æ–°ç§Ÿæˆ·æ’ä»¶",
  "author": "Your Team",
  "className": "NewTenantPlugin"
}
EOF

# 3. åˆ›å»ºæ’ä»¶å®žçŽ°
# å®žçŽ° plugins/tenants/new-tenant/index.ts

# 4. é‡å¯æœåŠ¡æˆ–çƒ­é‡è½½æ’ä»¶
```

### æ–°å¢žè®¾å¤‡ç±»åž‹
```bash
# 1. åœ¨ plugins/devices ä¸‹åˆ›å»ºæ–°æ–‡ä»¶å¤¹
mkdir plugins/devices/new-device-type

# 2. åˆ›å»ºé…ç½®æ–‡ä»¶
cat > plugins/devices/new-device-type/config.json << EOF
{
  "name": "new-device-type",
  "version": "1.0.0",
  "description": "æ–°è®¾å¤‡ç±»åž‹æ’ä»¶",
  "author": "Your Team",
  "className": "NewDevicePlugin"
}
EOF

# 3. åˆ›å»ºæ’ä»¶å®žçŽ°
# å®žçŽ° plugins/devices/new-device-type/index.ts

# 4. é‡å¯æœåŠ¡æˆ–çƒ­é‡è½½æ’ä»¶
```

### é…ç½®çƒ­æ›´æ–°
```typescript
// é€šè¿‡ API æ›´æ–°é…ç½®
await configManager.updateTenantConfig(tenantId, newConfig);
await configManager.updateDeviceConfig(tenantId, deviceType, newConfig);
await configManager.updateMQTTConfig(tenantId, deviceType, newConfig);
await configManager.updateOTAConfig(tenantId, deviceType, newConfig);
```

## ðŸ”§ æŠ€æœ¯ç‰¹æ€§

### 1. å¤šç§Ÿæˆ·éš”ç¦»
- ç§Ÿæˆ·çº§åˆ«çš„æ•°æ®éš”ç¦»
- ç§Ÿæˆ·ç‰¹å®šçš„é…ç½®ç®¡ç†
- ç§Ÿæˆ·çº§åˆ«çš„é™æµå’Œæƒé™æŽ§åˆ¶

### 2. åŠ¨æ€é…ç½®
- é…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†
- çƒ­æ›´æ–°æ”¯æŒ
- é…ç½®ç¼“å­˜å’ŒéªŒè¯

### 3. æ’ä»¶åŒ–æž¶æž„
- åŠ¨æ€æ’ä»¶åŠ è½½
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
- çƒ­é‡è½½æ”¯æŒ

### 4. ç»Ÿä¸€ä¸»é¢˜ç»“æž„
```
iot/{tenant}/{deviceType}/{deviceId}/{channel}/{subchannel?}
```

### 5. å½±å­æœºåˆ¶
- æœŸæœ›æ€å’ŒæŠ¥å‘Šæ€ç®¡ç†
- çŠ¶æ€å·®å¼‚è®¡ç®—
- åŽ†å²è®°å½•æŸ¥è¯¢

### 6. åŠ¨æ€å‡­è¯
- è®¾å¤‡å‡­è¯è‡ªåŠ¨ç”Ÿæˆ
- MQTT ACL è‡ªåŠ¨é…ç½®
- å‡­è¯è¿‡æœŸç®¡ç†

## ðŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
- ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
- é…ç½®ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
- å¹‚ç­‰æ€§ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰

### 2. é™æµç­–ç•¥
- å…¨å±€APIé™æµ
- è®¾å¤‡å¼•å¯¼é™æµ
- ç§Ÿæˆ·ç‰¹å®šé™æµ

### 3. æ¶ˆæ¯å¤„ç†
- æ¶ˆæ¯åŽ»é‡ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰
- æ‰¹é‡å¤„ç†
- å¼‚æ­¥å¤„ç†

## ðŸ”’ å®‰å…¨ç‰¹æ€§

### 1. è®¤è¯æŽˆæƒ
- å¤šå› ç´ è®¤è¯æ”¯æŒ
- ç»†ç²’åº¦æƒé™æŽ§åˆ¶
- ç§Ÿæˆ·éš”ç¦»

### 2. æ•°æ®å®‰å…¨
- åŠ¨æ€å‡­è¯ç”Ÿæˆ
- ACL è‡ªåŠ¨é…ç½®
- æ¶ˆæ¯ç­¾åéªŒè¯

### 3. ç½‘ç»œå®‰å…¨
- TLS æ”¯æŒ
- CORS é…ç½®
- è¯·æ±‚é™æµ

## ðŸŽ‰ æ€»ç»“

æˆ‘ä»¬æˆåŠŸå®žçŽ°äº†æ‚¨è¦æ±‚çš„ **æ ¸å¿ƒ+æ’ä»¶+é…ç½®ä¸­å¿ƒ** æž¶æž„ï¼š

âœ… **æ ¸å¿ƒæ¨¡å—**: æä¾›è®¤è¯ã€åŠ¨æ€å‡­è¯ã€é€‚é…å™¨ã€å½±å­æœºåˆ¶ã€é™æµã€æ—¥å¿—ã€å¹‚ç­‰ã€æ’ä»¶åŠ è½½å™¨
âœ… **é…ç½®ä¸­å¿ƒ**: é›†ä¸­ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·/è®¾å¤‡åŠ¨æ€é…ç½®ï¼Œæ”¯æŒçƒ­æ›´æ–°
âœ… **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒç§Ÿæˆ·å’Œè®¾å¤‡å®šåˆ¶åŒ–æ¨¡å—çš„åŠ¨æ€åŠ è½½
âœ… **ç¤ºä¾‹æ’ä»¶**: å±•ç¤ºäº†ç§Ÿæˆ·å’Œè®¾å¤‡å®šåˆ¶åŒ–åŠŸèƒ½
âœ… **å‘åŽå…¼å®¹**: ä¿æŒä¸ŽçŽ°æœ‰ä»£ç çš„å…¼å®¹æ€§

è¿™ä¸ªæž¶æž„å…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œæ”¯æŒï¼š
- æ–°å¢žç§Ÿæˆ·åªéœ€æ·»åŠ æ’ä»¶æ–‡ä»¶å¤¹
- æ–°å¢žè®¾å¤‡ç±»åž‹åªéœ€æ·»åŠ æ’ä»¶æ–‡ä»¶å¤¹
- é…ç½®æ›´æ–°æ— éœ€é‡å¯æœåŠ¡
- æ ¸å¿ƒä¸Žæ’ä»¶åˆ†å¼€ç‰ˆæœ¬ç®¡ç†

æž¶æž„å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ï¼ðŸš€
